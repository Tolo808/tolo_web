<!DOCTYPE html>
<html>

<head>
    <title>Tolo Statistics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #111;
            color: #eee;
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .tab {
            margin-right: 10px;
            color: #0af;
            text-decoration: none;
            padding: 8px 16px;
            background: #222;
            border-radius: 5px;
            cursor: pointer;
        }

        .tab.active {
            background: #4CAF50;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            max-width: 800px;
            margin: 0 auto 40px;
        }
    </style>
</head>

<body>
    <h1>📊 Tolo Delivery Statistics Dashboard</h1>
    <form method="get" style="margin-bottom: 20px;">
        <label for="days">Filter by days:</label>
        <select name="days" id="days" onchange="this.form.submit()">
            {% for d in [7, 14, 30, 60] %}
            <option value="{{ d }}" {% if selected_days==d %}selected{% endif %}>Last {{ d }} days</option>
            {% endfor %}
        </select>
    </form>
    <p>Showing data from the last <strong>{{ selected_days }}</strong> days.</p>
    <form method="get" action="/statistics/export_pdf" style="margin-bottom: 20px;">
        <input type="hidden" name="days" value="{{ selected_days }}">
        <button type="submit">📄 Download Registration Analytics PDF</button>
    </form>


    <div class="tabs">
        <div class="tab active" data-tab="daily">📆 Daily</div>
        <div class="tab" data-tab="status">🚚 Status</div>
        <div class="tab" data-tab="type">🛠 Type</div>
        <div class="tab" data-tab="drivers">🧑‍✈️ Drivers</div>
        <div class="tab" data-tab="users">👤 Users</div>
    </div>

    <div id="daily" class="tab-content active chart-container">
        <h2>📆 Daily Deliveries</h2>
    
        <label for="daysSelect" style="margin-right:8px;">Filter days:</label>
        <select id="daysSelect" style="margin-right:15px; padding:4px;">
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30" selected>Last 30 days</option>
        </select>
    
        <button id="exportDailyPdf"
            style="margin-bottom: 15px; padding: 8px 12px; background-color:#4CAF50; color:white; border:none; border-radius:5px; cursor:pointer;">
            Export Daily Registrations PDF
        </button>
    
        <canvas id="dailyChart"></canvas>
    </div>
    
    <script>
        document.getElementById('exportDailyPdf').addEventListener('click', () => {
            const days = document.getElementById('daysSelect').value;
            window.open(`/statistics/export_daily_pdf?days=${days}`, '_blank');
        });
    </script>

    
    <script>
        document.getElementById('exportDailyPdf').addEventListener('click', () => {
            // Adjust URL if you want to pass filters like days
            window.open('/statistics/export_daily_pdf', '_blank');
        });
    </script>


    <div id="status" class="tab-content chart-container">
        <h2>🚚 Delivery Status</h2>
        <canvas id="statusChart"></canvas>
    </div>

    <div id="type" class="tab-content chart-container">
        <h2>🛠 Service Type</h2>
        <canvas id="typeChart"></canvas>
    </div>

    <div id="drivers" class="tab-content chart-container">
        <h2>🧑‍✈️ Deliveries per Driver</h2>
        
        <label for="driverDaysSelect" style="margin-right:8px;">Filter days:</label>
        <select id="driverDaysSelect" style="margin-right:15px; padding:4px;">
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30" selected>Last 30 days</option>
        </select>
        
        <button id="exportDriverPdf"
            style="margin-bottom: 15px; padding: 8px 12px; background-color:#4CAF50; color:white; border:none; border-radius:5px; cursor:pointer;">
            Export Successful Deliveries PDF
        </button>
        <canvas id="driverChart"></canvas>
        <canvas id="driverChart"></canvas>

    </div>

    <div id="users" class="tab-content chart-container">
        <h2>👤 Unique Users</h2>
        <p>Total users registered: <strong>{{ total_users }}</strong></p>
    </div>

    <script>
        // Tab switching logic
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Daily Chart
        new Chart(document.getElementById('dailyChart'), {
            type: 'bar',
            data: {
                labels: {{ daily_counts.keys() | list | tojson }},
            datasets: [{
                label: 'Deliveries',
                data: {{ daily_counts.values() | list | tojson }},
            backgroundColor: '#42a5f5'
                }]
            }
        });

        // Status Chart
        new Chart(document.getElementById('statusChart'), {
            type: 'pie',
            data: {
                labels: {{ status_counts.keys() | list | tojson }},
            datasets: [{
                label: 'Status',
                data: {{ status_counts.values() | list | tojson }},
            backgroundColor: ['#66bb6a', '#ef5350', '#ffa726']
                }]
            }
        });

        // Type Chart
        new Chart(document.getElementById('typeChart'), {
            type: 'doughnut',
            data: {
                labels: {{ type_counts.keys() | list | tojson }},
            datasets: [{
                    label: 'Type',
                    data: {{ type_counts.values() | list | tojson }},
                    backgroundColor: ['#ab47bc', '#29b6f6', '#ffca28']
                }]
            }
        });

        // Driver Chart
        new Chart(document.getElementById('driverChart'), {
            type: 'bar',
            data: {
                labels: {{ driver_delivery_data.keys() | list | tojson }},
            datasets: [{
                label: 'Deliveries',
                data: {{ driver_delivery_data.values() | list | tojson }},
            backgroundColor: '#26a69a'
                }]
            }
        });
        document.getElementById('exportDriverPdf').addEventListener('click', () => {
                const days = document.getElementById('driverDaysSelect').value;
                window.open(`/statistics/export_driver_pdf?days=${days}`, '_blank');
            });

    </script>
</body>

</html>